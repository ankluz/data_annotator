# Data Annotator - Документация

## Обзор

Data Annotator - это инструмент на Python для аннотации изображений путем создания ограничивающих рамок (bounding boxes) и ключевых точек (keypoints). Библиотека предоставляет функциональность для обнаружения, отрисовки и аннотации ограничивающих рамок вокруг символов или объектов на изображениях, а также для добавления последовательностей ключевых точек внутри этих рамок.

## Установка

```bash
pip install data_annotator
```

Или из исходного кода:

```bash
git clone https://github.com/Ankluz/data_annotator.git
cd data_annotator
pip install -e .
```

## Требования

- OpenCV
- NumPy
- Matplotlib
- tkinter (для диалоговых окон ввода символов)

## Архитектура и основные компоненты

Библиотека состоит из следующих основных модулей:

1. **bbox_detector** - модуль для автоматического обнаружения ограничивающих рамок на изображении
   - Использует OpenCV для обнаружения объектов/символов на изображении
   - Применяет фильтрацию контуров по размеру и соотношению сторон
   - Возвращает список координат ограничивающих рамок

2. **bbox_editor** - модуль для ручной корректировки ограничивающих рамок
   - Предоставляет интерактивный интерфейс для редактирования рамок
   - Поддерживает выделение, перемещение, изменение размера и удаление рамок
   - Имеет управление масштабированием и перемещением по изображению
   - Позволяет создавать новые рамки и выбирать несколько рамок одновременно

3. **bbox_annotator** - модуль для аннотации ключевых точек внутри ограничивающих рамок
   - Позволяет добавлять последовательности ключевых точек внутри выбранной рамки
   - Поддерживает создание нескольких последовательностей точек
   - Включает функциональность ввода символов/меток для каждой рамки
   - Предоставляет управление масштабированием для точной аннотации

4. **file_processor** - модуль для сохранения и загрузки аннотаций
   - Сохраняет аннотации в структурированном JSON-формате
   - Загружает ранее сохраненные аннотации
   - Обрабатывает различные ошибки при работе с файлами (не найден, неверный формат и т.д.)
   - Поддерживает обратную совместимость с различными форматами аннотаций

5. **help_overlay** - модуль для отображения справочной информации в интерфейсе
   - Отображает полупрозрачную панель с информацией о горячих клавишах
   - Имеет настраиваемый текст справки для разных режимов работы
   - Использует полупрозрачное наложение для минимального перекрытия основного интерфейса

## Детальное описание функций

### Автоматическое обнаружение ограничивающих рамок

```python
from data_annotator import detect_and_draw_boxes

boxes = detect_and_draw_boxes("image.jpg", "output.jpg")
```

Функция `detect_and_draw_boxes` анализирует изображение и автоматически обнаруживает потенциальные объекты/символы, создавая для них ограничивающие рамки. 

**Процесс обнаружения:**
1. Загрузка изображения и преобразование в оттенки серого
2. Применение бинаризации для выделения объектов
3. Выполнение морфологических операций для улучшения обнаружения символов
4. Нахождение контуров на обработанном изображении
5. Фильтрация контуров по размеру и соотношению сторон
6. Сортировка контуров слева направо (для текстовых данных)
7. Преобразование контуров в ограничивающие рамки
8. Отрисовка рамок на выходном изображении

Результат также сохраняется в виде изображения с отрисованными рамками.

### Ручная корректировка ограничивающих рамок

```python
from data_annotator import manual_box_adjustment

annotations = manual_box_adjustment("image.jpg", boxes)
```

Функция `manual_box_adjustment` открывает интерактивное окно для настройки ограничивающих рамок. Она принимает список существующих рамок (например, полученных от `detect_and_draw_boxes`) или пустой список для создания рамок с нуля.

**Возможности редактирования рамок:**
- Выделение и перемещение рамок мышью
- Изменение размера рамок с помощью маркеров по краям
- Создание новых рамок (Alt + перетаскивание)
- Выбор нескольких рамок (Ctrl + клик)
- Удаление выбранных рамок (Del/X)
- Точное перемещение с помощью клавиш со стрелками
- Масштабирование изображения колесом мыши
- Перемещение по изображению (средняя кнопка мыши или Shift + перетаскивание)
- Сохранение текущего состояния рамок (S)
- Сброс масштаба и позиции (R)
- Отображение справки (H)

### Аннотация ключевых точек

```python
from data_annotator import annotate_keypoints

annotated_data = annotate_keypoints("image.jpg", annotations)
```

Функция `annotate_keypoints` открывает интерактивное окно для добавления ключевых точек внутри ограничивающих рамок. Поддерживается создание нескольких последовательностей точек в каждой рамке.

**Особенности аннотации ключевых точек:**
- Добавление точек с помощью левого клика мыши
- Навигация между рамками (A/D)
- Создание нескольких последовательностей точек (N)
- Переключение между последовательностями (E/Q)
- Отмена последней добавленной точки (Z)
- Ввод текстовых меток/символов для рамок (T)
- Масштабирование для точного позиционирования точек
- Перемещение по изображению для удобного доступа ко всем частям объекта

Возвращает структуру данных, содержащую рамки, последовательности точек и метки.

### Сохранение и загрузка аннотаций

```python
from data_annotator import save_annotations, load_annotations

# Сохранение аннотаций
save_annotations(annotated_data, "annotations.json")

# Загрузка аннотаций
loaded_data = load_annotations("annotations.json")
```

Эти функции обеспечивают сохранение и загрузку аннотаций в формате JSON.

**Формат сохраняемых данных:**
```json
[
  {
    "box": {
      "x": 10,
      "y": 20,
      "w": 100,
      "h": 50
    },
    "sequences": [
      [
        {"x": 15, "y": 25},
        {"x": 30, "y": 40},
        {"x": 45, "y": 35}
      ],
      [
        {"x": 50, "y": 30},
        {"x": 70, "y": 45}
      ]
    ],
    "symbol": "A"
  },
  // Другие аннотации...
]
```

Функция `load_annotations` обеспечивает устойчивость к ошибкам и включает обработку следующих исключений:
- Файл не найден
- Некорректный формат JSON
- Неверная структура данных
- Другие непредвиденные ошибки

## Интерактивные элементы управления

### Редактирование рамок (bbox_editor)

- **Левый клик + перетаскивание**: Переместить рамку
- **Alt + Левый клик + перетаскивание**: Создать новую рамку
- **Перетаскивание маркеров**: Изменить размер рамки
- **Клавиши со стрелками**: Переместить выбранную рамку на 1 пиксель
- **Левый клик + Ctrl**: Выбрать несколько рамок
- **Del/X**: Удалить выбранную рамку(и)
- **Колесико мыши**: Увеличить/уменьшить масштаб
- **Средняя кнопка мыши/Shift + перетаскивание**: Перемещение изображения
- **S**: Сохранить рамки в файл
- **ESC**: Завершить редактирование
- **H**: Включить/выключить справку
- **R**: Сбросить вид
- **C**: Очистить все выделения

### Аннотация ключевых точек (bbox_annotator)

- **Левый клик мыши**: Добавить ключевую точку
- **N**: Начать новую последовательность точек
- **E**: Перейти к следующей последовательности
- **Q**: Перейти к предыдущей последовательности
- **Z**: Отменить последнюю точку
- **D**: Перейти к следующей рамке
- **A**: Перейти к предыдущей рамке
- **T**: Ввести символ/метку для текущей рамки
- **Колесико мыши**: Увеличить/уменьшить масштаб
- **Средняя кнопка мыши/Shift+Drag**: Перемещение изображения
- **S**: Сохранить аннотации
- **R**: Сбросить вид (масштаб и положение)
- **H**: Включить/выключить справку
- **ESC**: Выход

## Формат данных

### Входные данные для annotate_keypoints

Функция `annotate_keypoints` принимает списки в одном из следующих форматов:

1. Список рамок `[(x, y, width, height), ...]`
2. Список кортежей `[(box, sequences), ...]`, где `box` - это `(x, y, width, height)`, а `sequences` - это список последовательностей ключевых точек
3. Список кортежей `[(box, sequences, symbol), ...]`, где дополнительный параметр `symbol` - это строка с меткой/символом рамки

### Выходные данные

Результатом работы функций аннотации является список кортежей в формате:
```
[(box, sequences, symbol), ...]
```
где:
- `box` - кортеж `(x, y, width, height)` с координатами ограничивающей рамки
- `sequences` - список последовательностей точек, где каждая последовательность - это список кортежей `(x, y)`
- `symbol` - строковая метка/символ для рамки

## Обработка ошибок

Библиотека включает обработку различных ошибок:
- Проверка существования файла изображения
- Валидация формата входных данных
- Преобразование различных форматов входных данных к единому стандарту
- Обработка ошибок при чтении/записи файлов аннотаций
- Проверка на корректность JSON-данных при загрузке аннотаций

## Примеры использования

### Полный пример рабочего процесса аннотации

```python
from data_annotator import detect_and_draw_boxes, manual_box_adjustment, annotate_keypoints, save_annotations

# Шаг 1: Автоматически обнаружить рамки
boxes = detect_and_draw_boxes("image.jpg", "boxes_detected.jpg")

# Шаг 2: Вручную скорректировать рамки
adjusted_boxes = manual_box_adjustment("image.jpg", boxes)

# Шаг 3: Аннотировать ключевые точки внутри рамок
annotations = annotate_keypoints("image.jpg", adjusted_boxes)

# Шаг 4: Сохранить результат
save_annotations(annotations, "annotations.json")
```

### Работа с существующими аннотациями

```python
from data_annotator import load_annotations, annotate_keypoints, save_annotations

# Загрузить существующие аннотации
annotations = load_annotations("existing_annotations.json")

# Продолжить аннотацию
updated_annotations = annotate_keypoints("image.jpg", annotations)

# Сохранить обновленные аннотации
save_annotations(updated_annotations, "updated_annotations.json")
```

### Только создание рамок без автоматического обнаружения

```python
from data_annotator import manual_box_adjustment, save_annotations

# Создать рамки с нуля
boxes = manual_box_adjustment("image.jpg", [])

# Сохранить только рамки без ключевых точек
save_annotations([(box, [], "") for box in boxes], "boxes_only.json")
```

## Информация о разработчике

Автор: Viktor Shitov
Email: viktovdmit@yandex.ru
GitHub: https://github.com/Ankluz/data_annotator

## Лицензия

Apache License 2.0 